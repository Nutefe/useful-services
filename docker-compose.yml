version: '3.8'

services:
  postgres:
    container_name: poc-postgres
    image: postgres:16-alpine
    restart: always
    networks:
      - internal-network
    environment:
      - POSTGRES_USER=poc
      - POSTGRES_PASSWORD=P@ssw0rd
      - POSTGRES_DB=db_poc
    volumes:
      - poc-postgres:/var/lib/postgresql/data
    # Ports expos√©s seulement en interne
    expose:
      - '5432'

  rabbitmq:
    container_name: poc-rabbitmq
    image: rabbitmq:4-management
    restart: always
    networks:
      - internal-network
      - traefik-network
    expose:
      - '5672'
      - '15672'
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.rabbitmq.rule=Host(`rabbitmq.nutefe.click`)'
      - 'traefik.http.routers.rabbitmq.entrypoints=websecure'
      - 'traefik.http.routers.rabbitmq.tls.certresolver=letsencrypt'
      - 'traefik.http.services.rabbitmq.loadbalancer.server.port=15672'
      - 'traefik.docker.network=traefik-network'

  auth-service:
    container_name: poc-auth-service
    build:
      context: .
      dockerfile: ./apps/auth-services/Dockerfile
      target: development
    command: sh -c "npx prisma generate && pnpm run start:dev auth-services"
    restart: always
    networks:
      - internal-network
      - traefik-network
    env_file:
      - .env.docker
      - ./apps/auth-services/.env.docker
    expose:
      - '3005'
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
      - /usr/src/app/node_modules/.prisma
    depends_on:
      - postgres
      - rabbitmq
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.auth-service.rule=Host(`auth.nutefe.click`)'
      - 'traefik.http.routers.auth-service.entrypoints=websecure'
      - 'traefik.http.routers.auth-service.tls.certresolver=letsencrypt'
      - 'traefik.http.services.auth-service.loadbalancer.server.port=3005'
      - 'traefik.docker.network=traefik-network'

  convoc-service:
    container_name: poc-convoc-service
    build:
      context: .
      dockerfile: ./apps/convoc-services/Dockerfile
      target: development
    command: sh -c "npx prisma generate && pnpm run start:dev convoc-services"
    restart: always
    networks:
      - internal-network
      - traefik-network
    env_file:
      - .env.docker
      - ./apps/convoc-services/.env.docker
    expose:
      - '3008'
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
      - /usr/src/app/node_modules/.prisma
    depends_on:
      - postgres
      - rabbitmq
      - auth-service
      - email-service
      - notification-service
      - file-service
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.convoc-service.rule=Host(`convoc.nutefe.click`)'
      - 'traefik.http.routers.convoc-service.entrypoints=websecure'
      - 'traefik.http.routers.convoc-service.tls.certresolver=letsencrypt'
      - 'traefik.http.services.convoc-service.loadbalancer.server.port=3008'
      - 'traefik.docker.network=traefik-network'

  email-service:
    container_name: poc-email-service
    build:
      context: .
      dockerfile: ./apps/email-services/Dockerfile
      target: development
    command: sh -c "npx prisma generate && pnpm run start:dev email-services"
    restart: always
    networks:
      - internal-network
      - traefik-network
    env_file:
      - .env.docker
      - ./apps/email-services/.env.docker
    expose:
      - '3007'
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
      - /usr/src/app/node_modules/.prisma
    depends_on:
      - postgres
      - rabbitmq
      - auth-service
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.email-service.rule=Host(`email.nutefe.click`)'
      - 'traefik.http.routers.email-service.entrypoints=websecure'
      - 'traefik.http.routers.email-service.tls.certresolver=letsencrypt'
      - 'traefik.http.services.email-service.loadbalancer.server.port=3007'
      - 'traefik.docker.network=traefik-network'

  file-service:
    container_name: poc-file-service
    build:
      context: .
      dockerfile: ./apps/file-services/Dockerfile
      target: development
    command: sh -c "npx prisma generate && pnpm run start:dev file-services"
    restart: always
    networks:
      - internal-network
      - traefik-network
    env_file:
      - .env.docker
      - ./apps/file-services/.env.docker
    expose:
      - '3009'
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
      - /usr/src/app/node_modules/.prisma
    depends_on:
      - postgres
      - rabbitmq
      - auth-service
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.file-service.rule=Host(`files.nutefe.click`)'
      - 'traefik.http.routers.file-service.entrypoints=websecure'
      - 'traefik.http.routers.file-service.tls.certresolver=letsencrypt'
      - 'traefik.http.services.file-service.loadbalancer.server.port=3009'
      - 'traefik.docker.network=traefik-network'

  notification-service:
    container_name: poc-notification-service
    build:
      context: .
      dockerfile: ./apps/notification-services/Dockerfile
      target: development
    command: sh -c "npx prisma generate && pnpm run start:dev notification-services"
    restart: always
    networks:
      - internal-network
      - traefik-network
    env_file:
      - .env.docker
      - ./apps/notification-services/.env.docker
    expose:
      - '3006'
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
      - /usr/src/app/node_modules/.prisma
    depends_on:
      - postgres
      - rabbitmq
      - auth-service
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.notification-service.rule=Host(`notifications.nutefe.click`)'
      - 'traefik.http.routers.notification-service.entrypoints=websecure'
      - 'traefik.http.routers.notification-service.tls.certresolver=letsencrypt'
      - 'traefik.http.services.notification-service.loadbalancer.server.port=3006'
      - 'traefik.docker.network=traefik-network'

networks:
  traefik-network:
    external: true
  internal-network:
    driver: bridge

volumes:
  poc-postgres:
