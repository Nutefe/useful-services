name: ðŸš€ Deploy to VPS

on:
  push:
    branches:
      - main # DÃ©clenche sur push vers main
  pull_request:
    branches:
      - main # DÃ©clenche sur PR vers main (pour tests)
  workflow_dispatch: # Permet de dÃ©clencher manuellement

jobs:
  deploy:
    name: ðŸŽ¯ Deploy to Production
    runs-on: ubuntu-latest

    # Ne dÃ©ployer que sur push (pas sur PR)
    if: github.event_name != 'pull_request'

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH Connection
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: ðŸ“‹ Add VPS to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: ðŸ§ª Test SSH Connection
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST "echo 'âœ… SSH connection successful'"

      - name: ðŸš€ Deploy Application
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PROJECT_DIR: ${{ secrets.VPS_PROJECT_DIR || 'useful-services' }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            
            echo "ðŸ“‚ Navigating to project directory..."
            cd ${{ secrets.VPS_PROJECT_DIR || 'useful-services' }}
            
            echo "ðŸ“¥ Pulling latest changes from GitHub..."
            git fetch origin
            git reset --hard origin/main
            git pull origin main
            
            echo "ðŸ›‘ Stopping existing containers..."
            docker-compose down
            
            echo "ðŸ—ï¸ Building Docker images..."
            docker-compose build --no-cache
            
            echo "ðŸš€ Starting services..."
            docker-compose up -d
            
            echo "â³ Waiting for services to start..."
            sleep 10
            
            echo "ðŸ“Š Checking services status..."
            docker-compose ps
            
            echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: ðŸ§¹ Cleanup Docker Resources
        if: success()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "ðŸ§¹ Cleaning up unused Docker resources..."
            docker system prune -af --volumes
            
            echo "ðŸ’¾ Current disk usage:"
            df -h | grep -E "Filesystem|/dev/sda|/dev/vda"
            
            echo "ðŸ³ Docker images:"
            docker images
            
            echo "âœ… Cleanup completed!"
          ENDSSH

      - name: ðŸ“§ Notify Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… âœ… âœ… DEPLOYMENT SUCCESSFUL âœ… âœ… âœ…"
            echo "ðŸŒ Application is now live at http://${{ secrets.VPS_HOST }}"
          else
            echo "DEPLOYMENT FAILED"
            echo "âš ï¸ Check the logs above for details"
          fi
