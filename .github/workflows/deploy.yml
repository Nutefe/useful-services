name: Deploiement Applications

on:
  push:
    branches:
      - main
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
    paths-ignore:
      - 'traefik/**' # Ignorer les changements de traefik
  pull_request:
    branches:
      - main

jobs:
  deploy-apps:
    name: DÃ©ploiement des services
    runs-on: ubuntu-latest

    if: github.event_name == 'push'

    steps:
      - name: Verifier le code source
        uses: actions/checkout@v4

      - name: Configuration SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Configuration du SSH
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: VÃ©rification de Traefik
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            # VÃ©rifier que Traefik tourne
            if ! docker ps | grep -q traefik; then
              echo "ERREUR: Traefik n'est pas en cours d'exÃ©cution!"
              echo "Lancez le workflow 'deploy-infrastructure' manuellement d'abord"
              exit 1
            fi
            echo "âœ… Traefik est actif"
          ENDSSH

      - name: Deploiement des applications
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PROJECT_DIR: ${{ secrets.VPS_PROJECT_DIR || 'useful-services' }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e

            cd ${{ secrets.VPS_PROJECT_DIR || 'useful-services' }}

            git fetch origin
            git reset --hard origin/main
            git pull origin main
            
            echo "ArrÃªt des conteneurs existants..."
            docker compose down
            
            echo "Construction des images Docker..."
            docker compose build --no-cache
            
            echo "DÃ©marrage des services..."
            docker compose up -d
            
            echo "Attente du dÃ©marrage..."
            sleep 20
            
            echo "VÃ©rification de l'Ã©tat des services..."
            docker compose ps
            
            echo "âœ… DÃ©ploiement terminÃ©!"
          ENDSSH

      - name: Nettoyage des ressources Docker inutilisÃ©es
        if: success()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "Nettoyage des ressources Docker inutilisÃ©es..."
            docker system prune -af --volumes || true
            
            echo "Utilisation actuelle du disque :"
            df -h | grep -E "Filesystem|/dev/sda|/dev/vda"
            
            echo "Images Docker :"
            docker images
            
            echo "Conteneurs en cours d'exÃ©cution :"
            docker ps
            
            echo "Nettoyage terminÃ© !"
          ENDSSH

      - name: Notification du statut du dÃ©ploiement
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… DÃ‰PLOIEMENT RÃ‰USSI"
            echo "ðŸŒ Services disponibles :"
            echo "  - Auth: https://auth.yourdomain.com"
            echo "  - Convoc: https://convoc.yourdomain.com"
            echo "  - Email: https://email.yourdomain.com"
            echo "  - Files: https://files.yourdomain.com"
            echo "  - Notifications: https://notifications.yourdomain.com"
            echo "  - RabbitMQ: https://rabbitmq.yourdomain.com"
          else
            echo "âŒ Ã‰CHEC DU DÃ‰PLOIEMENT"
            echo "VÃ©rifiez les journaux ci-dessus pour plus de dÃ©tails"
          fi
